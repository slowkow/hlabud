---
title: "hlabud"
author: "Kamil Slowikowski"
date: "`r format(Sys.Date())`"
output:
  md_document:
    toc: true
    variant: "markdown_github"
  html_document:
    toc: true
    self_contained: true
---

```{r,include=FALSE}
options(width=100)
library(data.table)
library(dplyr)
library(glue)
library(scales)
library(readr)
library(stringr)
library(magrittr)
library(ggplot2)
library(ggstance)
file_size <- function(x) glue("{fs::file_size(x)}B")

#' @importFrom ggplot2 theme_classic theme element_rect element_line
#'   element_blank element_text
#' @importFrom grid unit
theme_kamil <- theme_classic(
  base_family = "Arial",
  base_size = 16,
  base_line_size = 0.3,
  base_rect_size = 0.3
) +
theme(
  panel.spacing    = unit(2, "lines"),
  panel.border     = element_rect(linewidth = 0.5, fill = NA),
  axis.ticks       = element_line(linewidth = 0.4),
  axis.line        = element_blank(),
  strip.background = element_blank(),
  plot.title       = element_text(size = 16),
  plot.title.position = "plot",
  plot.subtitle    = element_text(size = 16),
  plot.caption     = element_text(size = 16),
  strip.text       = element_text(size = 16),
  legend.text      = element_text(size = 16),
  legend.title     = element_text(size = 16),
  axis.text        = element_text(size = 16),
  axis.title       = element_text(size = 16)
)
theme_set(theme_kamil)
options(
  ggplot2.discrete.colour = c(
    "#666666", "#E69F00", "#56B4E9", "#009E73", "#0072B2", "#D55E00", "#CC79A7"
  ),
  ggplot2.discrete.fill = c(
    "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#666666"
  )
)

mpn65 <- c(
  '#ff0029', '#377eb8', '#66a61e', '#984ea3', '#00d2d5', '#ff7f00', '#af8d00',
  '#7f80cd', '#b3e900', '#c42e60', '#a65628', '#f781bf', '#8dd3c7', '#bebada',
  '#fb8072', '#80b1d3', '#fdb462', '#fccde5', '#bc80bd', '#ffed6f', '#c4eaff',
  '#cf8c00', '#1b9e77', '#d95f02', '#e7298a', '#e6ab02', '#a6761d', '#0097ff',
  '#00d067', '#000000', '#252525', '#525252', '#737373', '#969696', '#bdbdbd',
  '#f43600', '#4ba93b', '#5779bb', '#927acc', '#97ee3f', '#bf3947', '#9f5b00',
  '#f48758', '#8caed6', '#f2b94f', '#eff26e', '#e43872', '#d9b100', '#9d7a00',
  '#698cff', '#d9d9d9', '#00d27e', '#d06800', '#009f82', '#c49200', '#cbe8ff',
  '#fecddf', '#c27eb6', '#8cd2ce', '#c4b8d9', '#f883b0', '#a49100', '#f48800',
  '#27d0df', '#a04a9b'
)


```

## Overview

hlabud provides functions to download and analyze human leukocyte antigen (HLA)
genotypes from [IMGTHLA] in a tidy R workflow.

[IMGTHLA]: https://github.com/ANHIG/IMGTHLA

## Installation

The quickest way to get hlabud is to install from GitHub:

```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("slowkow/hlabud")
```

## Examples

### Make a one-hot encoded matrix from a set of HLA alleles

We can use `hla_alignments("DQB1")` to load the `DQB1_prot.txt` file from the
latest IMGTHLA release:

```{r}
library(hlabud)
# Load the amino acid alignments for HLA-DQB1
al <- hla_alignments(gene = "DQB1", type = "prot")
```

The amino acid sequence alignments are in a data frame:

```{r}
al$sequences[1:5,]
```

And we get a one-hot encoded matrix with one column for each amino acid at each
position:

```{r}
al$onehot[1:5,1:5]
```

Now, suppose we have some individuals with the following genotypes:

```{r}
genotypes <- c(
  "DQB1*02:05+DQB1*02:05+DQB1*02:05",
  "DQB1*04:72+DQB1*03:02:26",
  "DQB1*04:60+DQB1*05:70",
  "DQB1*05:01:16+DQB1*04:80"
)
```

Suppose we want to run an association test on the amino acid positions.

We can use `amino_dosage()` to convert each individual's genotypes to amino
acid dosages:

```{r}
dosage <- amino_dosage(genotypes, al$onehot)
dosage
dim(dosage)
```

Notice:

* The `dosage` matrix has one row for each individual and one column for each
  amino acid at each position. By default, `amino_dosage()` will discard the
  columns where all individuals are identical.

* The first individual has `dosage=3` for `P6_D` (position 6 Asp). That's
  because we assigned this individual 3 alleles in our input.

Please be careful to check that your data looks the way you expect!

```{r, include=FALSE}
my_gene <- "DRB1"
al <- hla_alignments(gene = my_gene, type = "prot")
n_alleles <- nrow(al$seq)
```

### UMAP embedding of HLA-DRB1 alleles

Here is an embedding of `r n_alleles` HLA-DRB1 alleles created by passing the
one-hot amino acid encoding of the alleles as the input to UMAP:

```{r, cache=TRUE, echo = FALSE, fig.width = 9, fig.height = 6, message=FALSE, warning=FALSE}


library(uwot)

set.seed(2)
d <- umap(al$onehot, n_epochs = 200, min_dist = 1, spread = 2)

al$umap <- data.frame(allele = rownames(al$onehot), x = d[,1], y = d[,2])
al$umap %<>% mutate(allele = str_remove(allele, ".+\\*"))
al$umap %<>% mutate(d4 = str_extract(allele, "^[^:]+:[^:]+"))
al$umap %<>% mutate(d2 = str_extract(d4, "^[^:]+"))
al$umap %<>% mutate(m2 = str_extract(d4, "[^:]+$"))
al$umap$label <- ""
set.seed(2)
ix <- sample(1:nrow(al$umap), 40)
al$umap$label[ix] <- al$umap$d4[ix]

p <- ggplot(al$umap) +
  aes(x, y, color = d2) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = label), max.overlaps = 100) +
  scale_color_manual(values = mpn65) + 
  guides(color = guide_legend(title = "2-digit", override.aes = list(label = "", size = 5))) +
  labs(
    title = glue("{comma(nrow(al$umap))} HLA-{my_gene} alleles"),
    caption = glue("IMGTHLA {options('hlabud_release')}")
  ) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
  )
p
# ggsave("test.png", p)

```

We can highlight which alleles have amino acid H at position 13:

```{r, cache=TRUE, echo = FALSE, fig.width = 9, fig.height = 6, message=FALSE, warning=FALSE}
my_position <- "P13_H"
al$umap$color <- as.factor(as.integer(al$onehot[,my_position]))
p <- ggplot(al$umap) +
  aes(x, y, color = color) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = label), max.overlaps = 100) +
  guides(color = guide_legend(title = my_position, override.aes = list(label = "", size = 5))) +
  labs(
    title = glue("{comma(nrow(al$umap))} HLA-{my_gene} alleles"),
    caption = glue("IMGTHLA {options('hlabud_release')}")
  ) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
  )
p
# ggsave("test.png", p)
```

### Download and unpack the latest release from IMGTHLA

We can download and unpack all of the data for any IMGTHLA release:

```{r, eval=FALSE}
# Download all of the data (120MB) for the latest IMGTHLA release
install_hla(release = "latest")

# Or download a specific release
install_hla(release = "3.51.0")

# Where is the data being installed?
getOption("hlabud_dir")
#> [1] "/home/username/.local/share/hlabud"

# Check which release we are using
getOption("hlabud_release")
#> [1] "3.51.0"

# Use a specific release
options(hlabud_release = "3.51.0")
```

For example, here is an hlabud folder with data from 3 different releases:

```bash
❯ ls -lah "/home/user/.local/share/hlabud"
total 207M
drwxrwxr-x  3 user user      32 Apr  5 01:19 3.30.0
drwxrwxr-x 11 user user    4.0K Apr  7 19:31 3.40.0
drwxrwxr-x 12 user user    4.0K Apr  5 00:27 3.51.0
-rw-rw-r--  1 user user     15K Apr  7 19:23 tags.json
-rw-rw-r--  1 user user     79M Apr  7 19:28 v3.40.0-alpha.tar.gz
-rw-rw-r--  1 user user    129M Apr  4 20:07 v3.51.0-alpha.tar.gz
```

## Related work

### BIGDAWG

[BIGDAWG] is an R package available on CRAN that facilitates case-control
analysis of HLA data.

[BIGDAWG]: https://CRAN.R-project.org/package=BIGDAWG

> ‘Bridging ImmunoGenomic Data-Analysis Workflow Gaps’ (‘BIGDAWG’) is an
> integrated analysis system that automates the manual data-manipulation and
> trafficking steps (the gaps in an analysis workflow) normally required for
> analyses of highly polymorphic genetic systems (e.g., the immunological human
> leukocyte antigen (HLA) and killer-cell Immunoglobulin-like receptor (KIR)
> genes) and their respective genomic data (immunogenomic) 
> 
> Pappas DJ, Marin W, Hollenbach JA, Mack SJ. 2016. ‘Bridging ImmunoGenomic Data
> Analysis Workflow Gaps (BIGDAWG): An integrated case-control analysis
> pipeline.’ Human Immunology. 77:283-287).
> 
> Starting with unambiguous genotype data for case-control groups, ‘BIGDAWG’
> performs tests of Hardy-Weinberg equilibrium, and carries out case-control
> association analyses for haplotypes, individual loci, specific HLA exons, and
> HLA amino acid positions.

